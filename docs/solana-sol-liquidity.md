# Як Gateway використовує SOL та wSOL під час свопів Raydium

## 1. Базова модель

- У всіх Raydium пулах SOL представлений mint-адресою `So11111111111111111111111111111111111111112` (технічно **Wrapped SOL / wSOL**).
- Gateway працює із символом `SOL`, але на рівні інструкцій це завжди wSOL.
- Є два джерела лампортів:
  1. **Native SOL** (запис `type: "native"` у `/chains/solana/balances`).
  2. **wSOL** (запис `type: "base"` з тією ж mint-адресою).

## 2. Який баланс витрачається?

| Маршрут                                                                       | Що відбувається в коді                                                                                                                                      | Ваш контроль                                                                                                                                                    |
| ----------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **CLMM** (`src/connectors/raydium/clmm-routes/executeSwap.ts`, рядки 201/220) | `ownerInfo: { useSOLBalance: true }` → Raydium SDK спершу бере **native SOL** (wrap+unwrap автоматично). Якщо SOL не вистачає, використає наявний wSOL ATA. | Ви не передаєте прапор у request. Якщо хочете витрачати тільки wSOL – попередньо обгорніть весь SOL у wSOL (через гаманець) або тримайте SOL на іншому гаманці. |
| **AMM/CPMM** (`src/connectors/raydium/amm-routes/executeSwap.ts`)             | SDK працює лише з готовими SPL-акаунтами. Тобто спише **wSOL** з вашого ATA; native SOL йде тільки на fee.                                                  | Перед свопом самостійно конвертуйте потрібну суму в wSOL (Phantom ➝ Wrap SOL, `spl-token wrap`, тощо).                                                          |

## 3. Що приходить на виході?

- Raydium завжди зараховує результат у вигляді SPL-токена. Якщо вихідний mint = `So111…`, ви отримаєте **wSOL** на ATA.
- Прапора «віддати саме native SOL» немає. Навіть на CLMM-шляху `useSOLBalance: true` лише дозволяє тимчасово обійтися без попереднього wrap, але остаточний токен – той самий wSOL.
- Щоб мати чистий SOL після трейду, просто **unwrap** wSOL (Phantom: кнопка `Unwrap`, або `spl-token unwrap <WSOL-ATA>`).

## 4. Як зрозуміти, що саме буде використано

1. Викличте `GET /chains/solana/balances?wallet=...` і подивіться, скільки `SOL` у полях `type: "native"` та `type: "base"`.
2. Якщо робите CLMM-своп і маєте достатньо native SOL → Gateway автоматично заверне стільки, скільки потрібно.
3. Якщо робите AMM-своп → переконайтесь, що у записі `type: "base"` достатньо wSOL; інакше отримаєте `insufficient funds` при симуляції.

## 5. Як «регулювати» поведінку

- **Використати конкретно native SOL:** робіть CLMM-своп (або завжди забезпечуйте wrap для AMM). Гарантій «бери тільки native» немає – SDK просто заверне настільки, наскільки вистачає.
- **Використати тільки wSOL:** обгорніть SOL в гаманці, залиште мінімальний SOL лише для комісій. Для CLMM це змусить SDK брати з ATA, бо native SOL буде майже нульовий.
- **Отримати native SOL після трейду:** після відповіді API (там `tokenOut` = `So111...`) виконайте unwrap самостійно. Gateway цього не робить.

Тримайте цей файл поруч, якщо працюєте з гаманцем, де одночасно є і SOL, і wSOL. Основна ідея: API завжди оперує mint-адресою wSOL, а вибір між «нативний vs wrapped» робиться за рахунок ваших фактичних залишків та логіки Raydium SDK (CLMM – автоматично, AMM – тільки вручну).

## 6. Короткі відповіді на типові запитання

**Q:** Як точно дізнатись, який баланс (native чи wSOL) використається?

**A:** Подивись `/chains/solana/balances`. Для CLMM: якщо є достатньо native SOL, SDK сам заверне його (рядки 201/220 у `src/connectors/raydium/clmm-routes/executeSwap.ts`). Для AMM – використовуються лише гроші з wSOL ATA, тож зроби wrap перед свопом.

**Q:** Який SOL я отримаю після свопу? Чи можна одразу отримати native?

**A:** Результат завжди приходить як SPL-токен з mint `So111…` (wSOL). Native SOL не повертається автоматично, але ти можеш одразу після свопу виконати unwrap у гаманці/CLI. Gateway наразі не робить це за тебе.

## 7. Новий прапорець `useNativeSolBalance`

- В ендпоінтах `POST /connectors/raydium/amm/execute-swap` та `POST /connectors/raydium/clmm/execute-swap` зʼявилось поле:

```jsonc
"useNativeSolBalance": false
```

- За замовчуванням `false`, тобто Gateway використовує лише wSOL і не робить авто-wrap native SOL.
- Якщо встановити `true`, CLMM-свопи знову зможуть автоматично обгортати native SOL (AMM і далі працює лише з wSOL, але поле зберігається для сумісності запиту).
- Це дає змогу явно контролювати, щоб «нативний SOL тільки для комісій». Коли хочеш повернути автозавертання — просто встанови `useNativeSolBalance: true`.
